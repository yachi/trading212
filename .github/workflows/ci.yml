name: Continuous Integration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: short

jobs:
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./trading212-mcp-server
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
          cache: false  # Don't need cache for fmt
      - run: cargo fmt --check

  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    needs: fmt  # Only run if formatting passes
    defaults:
      run:
        working-directory: ./trading212-mcp-server
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy
          cache: true
          rustflags: "-D warnings"
          cache-workspaces: "./trading212-mcp-server -> target"
          cache-on-failure: true
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Check Cargo.toml exists
        run: |
          if [ ! -f "Cargo.toml" ]; then
            echo "❌ Cargo.toml not found in trading212-mcp-server directory"
            exit 1
          fi
          echo "✅ Found Cargo.toml"

      - name: Run clippy
        run: |
          echo "🔍 Running cargo clippy..."
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Run tests
        run: |
          echo "🧪 Running tests with nextest..."
          cargo nextest run --all-features
        env:
          TRADING212_API_KEY: "test_api_key_for_ci"

      - name: Check compilation
        run: |
          echo "🔧 Running cargo check..."
          cargo check --all-targets --all-features

      - name: Quality checks summary
        if: success()
        run: echo "✅ All quality checks passed!"