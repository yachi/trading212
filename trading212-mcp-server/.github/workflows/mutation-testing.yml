name: Mutation Testing

on:
  # Run on pull requests to main
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.cargo/mutants.toml'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Weekly scheduled run
  schedule:
    - cron: '0 0 * * 0'  # Sunday at midnight

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  mutation-testing:
    name: Run Mutation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper diff generation
          fetch-depth: 0
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            trading212-mcp-server/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Install cargo-mutants
        run: |
          if ! command -v cargo-mutants &> /dev/null; then
            cargo install cargo-mutants
          fi
        working-directory: ./trading212-mcp-server
      
      - name: Run incremental mutation testing on PR
        if: github.event_name == 'pull_request'
        run: |
          # Generate diff using merge-base approach (following cargo-mutants best practices)
          # Fixed: Strip project prefix from diff paths for cargo-mutants compatibility
          echo "=== DEBUGGING CARGO-MUTANTS WORKFLOW ==="
          echo "Current working directory: $(pwd)"
          echo "Current branch: $(git branch --show-current)"
          echo "Base ref: ${{ github.base_ref }}"
          echo "Head ref: ${{ github.head_ref }}"
          echo "Available files: $(ls -la)"

          # Find merge base and generate diff
          MERGE_BASE=$(git merge-base origin/${{ github.base_ref }} HEAD)
          echo "Merge base: $MERGE_BASE"

          echo "=== GENERATING DIFF ==="
          git diff "$MERGE_BASE"..HEAD | sed 's|trading212-mcp-server/||g' > pr.diff
          echo "Diff generated, size: $(wc -l < pr.diff) lines"

          # Show diff stats for debugging
          echo "=== FILES CHANGED ==="
          git diff --name-only "$MERGE_BASE"..HEAD || echo "No files changed"

          echo "=== FIRST 30 LINES OF DIFF ==="
          head -30 pr.diff || echo "Empty diff"

          echo "=== CARGO PROJECT CHECK ==="
          echo "Cargo.toml exists: $(test -f Cargo.toml && echo 'YES' || echo 'NO')"
          echo "src/ directory exists: $(test -d src && echo 'YES' || echo 'NO')"

          if [ -f Cargo.toml ]; then
            echo "Cargo.toml content (first 10 lines):"
            head -10 Cargo.toml
          fi

          # Run cargo mutants with diff
          if [ -s pr.diff ]; then
            echo "=== RUNNING CARGO MUTANTS ==="
            echo "Testing cargo mutants --list first..."
            MUTANT_COUNT=$(cargo mutants --list --in-diff pr.diff | wc -l)
            echo "Found $MUTANT_COUNT mutations to test"

            echo "Now running actual mutations..."
            mkdir -p mutants-pr.out

            # Run cargo mutants with timeout handling
            timeout 300s cargo mutants --no-shuffle -vV --in-diff pr.diff \
              --timeout 60 \
              --output mutants-pr.out || {
              echo "Cargo mutants failed or timed out, creating fallback results"

              # Create fallback outcomes.json based on what we know
              cat > mutants-pr.out/outcomes.json << EOF
{
  "summary": {
    "total": $MUTANT_COUNT,
    "caught": 0,
    "missed": 0,
    "unviable": 0,
    "timeout": $MUTANT_COUNT
  },
  "outcomes": []
}
EOF
            }
          else
            echo "=== NO DIFF FOUND ==="
            echo "Creating empty output directory"
            mkdir -p mutants-pr.out
            echo '{"summary":{"total":0,"caught":0,"missed":0,"unviable":0,"timeout":0}}' > mutants-pr.out/outcomes.json
          fi

          # Ensure outcomes.json exists
          if [ ! -f "mutants-pr.out/outcomes.json" ]; then
            echo "outcomes.json missing, creating fallback"
            echo '{"summary":{"total":0,"caught":0,"missed":0,"unviable":0,"timeout":1}}' > mutants-pr.out/outcomes.json
          fi

          echo "=== FINAL RESULTS ==="
          cat mutants-pr.out/outcomes.json || echo "No outcomes file found"
        working-directory: ./trading212-mcp-server
        continue-on-error: true
      
      - name: Run full mutation testing
        if: github.event_name != 'pull_request'
        run: cargo mutants --output mutants-full.out
        working-directory: ./trading212-mcp-server
        continue-on-error: true
      
      - name: Generate mutation report summary
        if: always()
        run: |
          if [ -d "mutants-pr.out" ]; then
            echo "## PR Mutation Testing Results (Changed Lines Only)" >> $GITHUB_STEP_SUMMARY
            cat mutants-pr.out/outcomes.json | jq -r '
              "- Total: \(.summary.total)",
              "- Caught: \(.summary.caught)",
              "- Missed: \(.summary.missed)",
              "- Unviable: \(.summary.unviable)",
              "- Timeout: \(.summary.timeout)"
            ' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Report parsing failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "mutants-full.out" ]; then
            echo "## Full Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
            cat mutants-full.out/outcomes.json | jq -r '
              "- Total: \(.summary.total)",
              "- Caught: \(.summary.caught)",
              "- Missed: \(.summary.missed)",
              "- Unviable: \(.summary.unviable)",
              "- Timeout: \(.summary.timeout)"
            ' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Report parsing failed" >> $GITHUB_STEP_SUMMARY
          fi
        working-directory: ./trading212-mcp-server
      
      - name: Upload mutation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report-${{ github.sha }}
          path: |
            trading212-mcp-server/mutants-pr.out/
            trading212-mcp-server/mutants-full.out/
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## üß¨ Mutation Testing Results (Changed Lines Only)\n\n' +
                         '> This PR was tested using incremental mutation testing (`--in-diff`) which only tests mutations in changed lines, making it faster and more focused.\n\n';
            
            try {
              const outcomes = JSON.parse(fs.readFileSync('trading212-mcp-server/mutants-pr.out/outcomes.json', 'utf8'));
              const total = outcomes.summary.total || 0;
              const caught = outcomes.summary.caught || 0;
              const missed = outcomes.summary.missed || 0;
              const score = total > 0 ? ((caught / total) * 100).toFixed(1) : 0;
              
              comment += `**Mutation Score: ${score}%**\n\n`;
              comment += `| Metric | Count |\n|--------|-------|\n`;
              comment += `| Total Mutations | ${total} |\n`;
              comment += `| Caught | ${caught} ‚úÖ |\n`;
              comment += `| Missed | ${missed} ‚ö†Ô∏è |\n`;
              comment += `| Unviable | ${outcomes.summary.unviable || 0} |\n`;
              comment += `| Timeout | ${outcomes.summary.timeout || 0} |\n`;
              
              if (missed > 0) {
                comment += `\n‚ö†Ô∏è **${missed} mutations were not caught by tests.**\n`;
                comment += `Review the mutation report artifact for details.\n`;
              }
            } catch (e) {
              comment += 'Failed to parse mutation testing results.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
